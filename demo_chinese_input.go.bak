// Demo program to demonstrate Chinese input optimization functionality
// æ¼”ç¤ºç¹é«”ä¸­æ–‡è¼¸å…¥æ³•å„ªåŒ–åŠŸèƒ½çš„ç¤ºä¾‹ç¨‹å¼
package main

import (
	"fmt"
	"fyne.io/fyne/v2"
	"fyne.io/fyne/v2/app"
	"fyne.io/fyne/v2/container"
	"fyne.io/fyne/v2/widget"
	"mac-notebook-app/ui"
	"mac-notebook-app/internal/services"
)

func main() {
	// å»ºç«‹æ‡‰ç”¨ç¨‹å¼
	myApp := app.NewWithID("chinese-input-demo")
	myWindow := myApp.NewWindow("ç¹é«”ä¸­æ–‡è¼¸å…¥æ³•å„ªåŒ–æ¼”ç¤º")
	myWindow.Resize(fyne.NewSize(1000, 700))

	// å»ºç«‹ä¸­æ–‡è¼¸å…¥å¢å¼·å™¨
	chineseInputEnhancer := ui.NewChineseInputEnhancer()
	
	// å»ºç«‹ä¸­æ–‡è¼¸å…¥æœå‹™
	chineseInputService := services.NewChineseInputService()
	
	// å»ºç«‹è¼¸å…¥æ³•æ•´åˆæœå‹™
	imeService := services.NewIMEIntegrationService()

	// å»ºç«‹åˆ†æçµæœé¡¯ç¤ºå€åŸŸ
	analysisLabel := widget.NewLabel("æ–‡å­—åˆ†æçµæœå°‡åœ¨æ­¤é¡¯ç¤º")
	analysisLabel.Wrapping = fyne.TextWrapWord
	
	compositionLabel := widget.NewLabel("æ–‡å­—çµ„æˆåˆ†æï¼š")
	compositionLabel.Wrapping = fyne.TextWrapWord
	
	optimizationLabel := widget.NewLabel("è¼¸å…¥æ³•å„ªåŒ–å»ºè­°ï¼š")
	optimizationLabel.Wrapping = fyne.TextWrapWord
	
	validationLabel := widget.NewLabel("è¼¸å…¥é©—è­‰çµæœï¼š")
	validationLabel.Wrapping = fyne.TextWrapWord

	// å»ºç«‹æ§åˆ¶é¢æ¿
	controlPanel := container.NewVBox(
		widget.NewLabel("ğŸ›ï¸ ä¸­æ–‡è¼¸å…¥æ§åˆ¶é¢æ¿"),
		widget.NewSeparator(),
		
		// åŸºæœ¬è¨­å®š
		widget.NewCheck("é¡¯ç¤ºå€™é¸å­—è¦–çª—", func(checked bool) {
			chineseInputEnhancer.SetShowCandidates(checked)
			fmt.Printf("å€™é¸å­—è¦–çª—é¡¯ç¤º: %v\n", checked)
		}),
		
		widget.NewCheck("å•Ÿç”¨è‡ªå‹•å®Œæˆ", func(checked bool) {
			chineseInputEnhancer.SetAutoComplete(checked)
			fmt.Printf("è‡ªå‹•å®Œæˆ: %v\n", checked)
		}),
		
		widget.NewSeparator(),
		
		// å­—å‹è¨­å®š
		widget.NewLabel("å­—å‹è¨­å®šï¼š"),
		widget.NewButton("PingFang TC", func() {
			chineseInputEnhancer.SetFontName("PingFang TC")
			fmt.Println("è¨­å®šå­—å‹ï¼šPingFang TC")
		}),
		widget.NewButton("Heiti TC", func() {
			chineseInputEnhancer.SetFontName("Heiti TC")
			fmt.Println("è¨­å®šå­—å‹ï¼šHeiti TC")
		}),
		
		widget.NewSeparator(),
		
		// å­—å‹å¤§å°
		widget.NewLabel("å­—å‹å¤§å°ï¼š"),
		func() *widget.Slider {
			slider := widget.NewSlider(10, 24)
			slider.Value = 14
			slider.OnChanged = func(value float64) {
				chineseInputEnhancer.SetFontSize(float32(value))
				fmt.Printf("è¨­å®šå­—å‹å¤§å°ï¼š%.0f\n", value)
			}
			return slider
		}(),
		
		widget.NewSeparator(),
		
		// åˆ†æåŠŸèƒ½
		widget.NewButton("ğŸ” åˆ†ææ–‡å­—", func() {
			text := chineseInputEnhancer.GetText()
			analyzeText(text, chineseInputService, analysisLabel, compositionLabel, optimizationLabel, validationLabel)
		}),
		
		widget.NewButton("ğŸ§¹ æ¸…ç©ºæ–‡å­—", func() {
			chineseInputEnhancer.SetText("")
			analysisLabel.SetText("æ–‡å­—åˆ†æçµæœå°‡åœ¨æ­¤é¡¯ç¤º")
			compositionLabel.SetText("æ–‡å­—çµ„æˆåˆ†æï¼š")
			optimizationLabel.SetText("è¼¸å…¥æ³•å„ªåŒ–å»ºè­°ï¼š")
			validationLabel.SetText("è¼¸å…¥é©—è­‰çµæœï¼š")
		}),
		
		widget.NewSeparator(),
		
		// è¼¸å…¥æ³•æ§åˆ¶
		widget.NewLabel("è¼¸å…¥æ³•æ§åˆ¶ï¼š"),
		widget.NewButton("åˆ‡æ›åˆ°ä¸­æ–‡è¼¸å…¥æ³•", func() {
			err := imeService.SwitchToChineseIME()
			if err != nil {
				fmt.Printf("åˆ‡æ›åˆ°ä¸­æ–‡è¼¸å…¥æ³•å¤±æ•—: %v\n", err)
			} else {
				fmt.Printf("å·²åˆ‡æ›åˆ°ä¸­æ–‡è¼¸å…¥æ³•: %s\n", imeService.GetCurrentIME())
			}
		}),
		
		widget.NewButton("åˆ‡æ›åˆ°è‹±æ–‡è¼¸å…¥æ³•", func() {
			err := imeService.SwitchToEnglishIME()
			if err != nil {
				fmt.Printf("åˆ‡æ›åˆ°è‹±æ–‡è¼¸å…¥æ³•å¤±æ•—: %v\n", err)
			} else {
				fmt.Printf("å·²åˆ‡æ›åˆ°è‹±æ–‡è¼¸å…¥æ³•: %s\n", imeService.GetCurrentIME())
			}
		}),
		
		widget.NewSeparator(),
		
		// æ¸¬è©¦æ–‡å­—æŒ‰éˆ•
		widget.NewLabel("å¿«é€Ÿæ¸¬è©¦ï¼š"),
		widget.NewButton("æ’å…¥ä¸­æ–‡ç¯„ä¾‹", func() {
			sampleText := "é€™æ˜¯ä¸€å€‹ç¹é«”ä¸­æ–‡è¼¸å…¥æ³•å„ªåŒ–çš„æ¸¬è©¦ç¯„ä¾‹ã€‚åŒ…å«å„ç¨®ä¸­æ–‡å­—ç¬¦ã€æ¨™é»ç¬¦è™Ÿï¼Œä»¥åŠä¸€äº›Englishæ··åˆå…§å®¹ã€‚"
			chineseInputEnhancer.SetText(sampleText)
			analyzeText(sampleText, chineseInputService, analysisLabel, compositionLabel, optimizationLabel, validationLabel)
		}),
		
		widget.NewButton("æ’å…¥æ³¨éŸ³ç¯„ä¾‹", func() {
			sampleText := "ã„“ã„œË‹ ã„•Ë‹ ã„“ã„¨Ë‹ ã„§ã„£ ã„ˆã„¨ËŠ ã„ã„ Ë‹ ã„˜ã„œË‹ ã„•Ë‹"
			chineseInputEnhancer.SetText(sampleText)
			analyzeText(sampleText, chineseInputService, analysisLabel, compositionLabel, optimizationLabel, validationLabel)
			
			// æ¨¡æ“¬æ³¨éŸ³è¼¸å…¥æ³•çµ„åˆ
			err := imeService.StartComposition("ã„‹ã„§Ë‡ã„ã„ Ë‡")
			if err == nil {
				candidates := imeService.GetCandidates()
				fmt.Printf("æ³¨éŸ³å€™é¸å­—: %v\n", candidates)
			}
		}),
		
		widget.NewButton("æ’å…¥æ··åˆç¯„ä¾‹", func() {
			sampleText := "Hello ä½ å¥½ï¼This is æ¸¬è©¦ 123 æ··åˆæ–‡å­—ã€‚"
			chineseInputEnhancer.SetText(sampleText)
			analyzeText(sampleText, chineseInputService, analysisLabel, compositionLabel, optimizationLabel, validationLabel)
		}),
		
		widget.NewButton("æ¸¬è©¦çµ„åˆè¼¸å…¥", func() {
			// æ¸¬è©¦æ³¨éŸ³çµ„åˆè¼¸å…¥
			testCompositions := []string{"ã„‹ã„§Ë‡", "ã„ã„ Ë‡", "ã„•Ë‹", "ã„ã„§ã„Ë‹"}
			for _, comp := range testCompositions {
				err := imeService.StartComposition(comp)
				if err == nil {
					candidates := imeService.GetCandidates()
					fmt.Printf("çµ„åˆ '%s' çš„å€™é¸å­—: %v\n", comp, candidates)
					imeService.CancelComposition()
				}
			}
		}),
	)

	// è¨­å®šä¸­æ–‡è¼¸å…¥å¢å¼·å™¨çš„å›èª¿å‡½æ•¸
	chineseInputEnhancer.SetOnTextChanged(func(text string) {
		fmt.Printf("æ–‡å­—è®Šæ›´: %s\n", text)
		// å³æ™‚åˆ†ææ–‡å­—
		if text != "" {
			analyzeText(text, chineseInputService, analysisLabel, compositionLabel, optimizationLabel, validationLabel)
		}
	})

	chineseInputEnhancer.SetOnCompositionChanged(func(text string) {
		fmt.Printf("çµ„åˆæ–‡å­—è®Šæ›´: %s\n", text)
	})

	chineseInputEnhancer.SetOnCandidateSelected(func(word string) {
		fmt.Printf("é¸æ“‡å€™é¸å­—: %s\n", word)
	})

	// å»ºç«‹åˆ†æçµæœé¢æ¿
	analysisPanel := container.NewVBox(
		widget.NewLabel("ğŸ“Š æ–‡å­—åˆ†æçµæœ"),
		widget.NewSeparator(),
		analysisLabel,
		widget.NewSeparator(),
		compositionLabel,
		widget.NewSeparator(),
		optimizationLabel,
		widget.NewSeparator(),
		validationLabel,
	)

	// å»ºç«‹ä¸»è¦ä½ˆå±€
	leftPanel := container.NewVBox(
		controlPanel,
	)

	rightPanel := container.NewVBox(
		analysisPanel,
	)

	mainContent := container.NewHSplit(
		leftPanel,
		container.NewVSplit(
			chineseInputEnhancer.GetContainer(),
			rightPanel,
		),
	)
	mainContent.Offset = 0.3 // å·¦å´é¢æ¿ä½” 30%

	// å»ºç«‹å®Œæ•´ä½ˆå±€
	fullLayout := container.NewVBox(
		widget.NewLabel("ğŸ‰ ç¹é«”ä¸­æ–‡è¼¸å…¥æ³•å„ªåŒ–åŠŸèƒ½æ¼”ç¤º"),
		widget.NewSeparator(),
		mainContent,
	)

	// è¨­å®šè¦–çª—å…§å®¹
	myWindow.SetContent(fullLayout)

	// é¡¯ç¤ºèªªæ˜
	fmt.Println("ğŸ‰ ç¹é«”ä¸­æ–‡è¼¸å…¥æ³•å„ªåŒ–æ¼”ç¤ºç¨‹å¼å·²å•Ÿå‹•ï¼")
	fmt.Println("ğŸ“‹ åŠŸèƒ½èªªæ˜ï¼š")
	fmt.Println("   - åœ¨ä¸Šæ–¹æ–‡å­—è¼¸å…¥å€åŸŸè¼¸å…¥ä¸­æ–‡å…§å®¹")
	fmt.Println("   - ä½¿ç”¨å·¦å´æ§åˆ¶é¢æ¿èª¿æ•´ä¸­æ–‡è¼¸å…¥è¨­å®š")
	fmt.Println("   - é»æ“Šã€Œåˆ†ææ–‡å­—ã€æŒ‰éˆ•æŸ¥çœ‹è©³ç´°åˆ†æçµæœ")
	fmt.Println("   - ä½¿ç”¨å¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•æ’å…¥ç¯„ä¾‹æ–‡å­—")
	fmt.Println("   - æ‰€æœ‰æ“ä½œéƒ½æœƒåœ¨çµ‚ç«¯é¡¯ç¤ºè©³ç´°è³‡è¨Š")
	fmt.Println("")

	// è¨­å®šé è¨­å€¼
	chineseInputEnhancer.SetShowCandidates(true)
	chineseInputEnhancer.SetAutoComplete(true)

	// é¡¯ç¤ºè¦–çª—ä¸¦é‹è¡Œ
	myWindow.ShowAndRun()
}

// analyzeText åˆ†ææ–‡å­—å…§å®¹ä¸¦æ›´æ–°é¡¯ç¤º
// åƒæ•¸ï¼š
//   - text: è¦åˆ†æçš„æ–‡å­—
//   - service: ä¸­æ–‡è¼¸å…¥æœå‹™
//   - labels: å„ç¨®é¡¯ç¤ºæ¨™ç±¤
func analyzeText(text string, service services.ChineseInputService, analysisLabel, compositionLabel, optimizationLabel, validationLabel *widget.Label) {
	if text == "" {
		return
	}

	// åŸºæœ¬åˆ†æ
	hasChineseChars := service.ContainsChineseCharacters(text)
	chineseCharCount := service.CountChineseCharacters(text)
	
	basicAnalysis := fmt.Sprintf("æ–‡å­—é•·åº¦: %d å­—ç¬¦\nåŒ…å«ä¸­æ–‡: %v\nä¸­æ–‡å­—ç¬¦æ•¸: %d",
		len([]rune(text)), hasChineseChars, chineseCharCount)
	analysisLabel.SetText(basicAnalysis)

	// æ–‡å­—çµ„æˆåˆ†æ
	composition := service.AnalyzeTextComposition(text)
	compositionText := fmt.Sprintf("ç¸½å­—ç¬¦: %d\nä¸­æ–‡å­—ç¬¦: %d (%.1f%%)\nè‹±æ–‡å­—ç¬¦: %d\næ•¸å­—å­—ç¬¦: %d\næ¨™é»ç¬¦è™Ÿ: %d\nç©ºç™½å­—ç¬¦: %d",
		composition.TotalCharacters,
		composition.ChineseCharacters,
		composition.ChineseRatio*100,
		composition.EnglishCharacters,
		composition.NumberCharacters,
		composition.PunctuationMarks,
		composition.WhitespaceChars)
	compositionLabel.SetText("æ–‡å­—çµ„æˆåˆ†æï¼š\n" + compositionText)

	// è¼¸å…¥æ³•å„ªåŒ–åˆ†æ
	optimization := service.OptimizeInputMethod(text)
	optimizationText := fmt.Sprintf("ä¿¡å¿ƒåˆ†æ•¸: %.2f\n", optimization.ConfidenceScore)
	
	if len(optimization.Corrections) > 0 {
		optimizationText += "ä¿®æ­£å»ºè­°:\n"
		for _, correction := range optimization.Corrections {
			optimizationText += "â€¢ " + correction + "\n"
		}
	}
	
	if len(optimization.Improvements) > 0 {
		optimizationText += "æ”¹å–„å»ºè­°:\n"
		for _, improvement := range optimization.Improvements {
			optimizationText += "â€¢ " + improvement + "\n"
		}
	}
	
	if len(optimization.Corrections) == 0 && len(optimization.Improvements) == 0 {
		optimizationText += "è¼¸å…¥è‰¯å¥½ï¼Œç„¡éœ€å„ªåŒ–å»ºè­°ã€‚"
	}
	
	optimizationLabel.SetText("è¼¸å…¥æ³•å„ªåŒ–å»ºè­°ï¼š\n" + optimizationText)

	// è¼¸å…¥é©—è­‰
	validation := service.ValidateChineseInput(text)
	validationText := fmt.Sprintf("é©—è­‰çµæœ: %v\n", validation.IsValid)
	
	if len(validation.Errors) > 0 {
		validationText += "éŒ¯èª¤:\n"
		for _, error := range validation.Errors {
			validationText += "â€¢ " + error + "\n"
		}
	}
	
	if len(validation.Warnings) > 0 {
		validationText += "è­¦å‘Š:\n"
		for _, warning := range validation.Warnings {
			validationText += "â€¢ " + warning + "\n"
		}
	}
	
	if len(validation.Suggestions) > 0 {
		validationText += "å»ºè­°:\n"
		for _, suggestion := range validation.Suggestions {
			validationText += "â€¢ " + suggestion + "\n"
		}
	}
	
	validationLabel.SetText("è¼¸å…¥é©—è­‰çµæœï¼š\n" + validationText)

	// åœ¨çµ‚ç«¯è¼¸å‡ºè©³ç´°åˆ†æ
	fmt.Println("ğŸ“Š æ–‡å­—åˆ†æçµæœï¼š")
	fmt.Printf("   æ–‡å­—å…§å®¹: %s\n", text)
	fmt.Printf("   %s\n", basicAnalysis)
	fmt.Printf("   ä¸­æ–‡æ¯”ä¾‹: %.1f%%\n", composition.ChineseRatio*100)
	fmt.Printf("   å„ªåŒ–ä¿¡å¿ƒåˆ†æ•¸: %.2f\n", optimization.ConfidenceScore)
	fmt.Printf("   é©—è­‰çµæœ: %v\n", validation.IsValid)
	fmt.Println("")
}